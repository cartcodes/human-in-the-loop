# n8n Human-in-the-Loop Setup Guide

## Quick Setup Steps

### Step 1: HTTP Request Node Configuration
Place this **AFTER** your trigger node and **BEFORE** the Wait node:

**Node Name:** Register Approval Request
**Method:** POST
**URL:** `https://carter.ngrok.app/webhook/register`
**Authentication:** None
**Send Body:** JSON
**Specify Body:** Using JSON

**JSON Body (Copy this exactly):**
```json
{
  "executionId": "{{ $execution.id }}",
  "resumeUrl": "{{ $execution.resumeUrl }}",
  "workflowName": "{{ $workflow.name }}",
  "data": {
    "description": "{{ $json.description || 'Approval needed' }}",
    "amount": "{{ $json.amount || 0 }}",
    "requestor": "{{ $json.requestor || 'System' }}"
  }
}
```

### Step 2: Wait Node Configuration
Place this **IMMEDIATELY AFTER** the HTTP Request node:

**Resume:** On Webhook Call
**HTTP Method:** POST
**Response Code:** 200
**Respond:** Immediately
**Authentication:** None

### Step 3: IF Node Configuration
Place this **AFTER** the Wait node to check the approval:

**Conditions:**
- Value 1: `{{ $json.approved }}`
- Operation: Equal
- Value 2: `true`

## Complete Node Order:
```
1. [Your Trigger] → 2. [HTTP Request] → 3. [Wait] → 4. [IF] → 5a. [Approved] / 5b. [Rejected]
```

## Test with CURL

Test the registration endpoint:
```bash
curl -X POST https://carter.ngrok.app/webhook/register \
  -H "Content-Type: application/json" \
  -d '{
    "executionId": "test-123",
    "resumeUrl": "https://webhook.site/your-test-url",
    "workflowName": "Test Workflow",
    "data": {
      "description": "Test approval request",
      "amount": 1000,
      "requestor": "John Doe"
    }
  }'
```

## What Happens:

1. Your workflow triggers
2. HTTP Request sends the execution details to the approval system
3. Wait node pauses and waits for webhook callback
4. You open https://carter.ngrok.app to see pending approvals
5. You click Approve/Reject
6. The system calls the resumeUrl with the decision
7. Workflow continues based on approval status

## Important Notes:

- The `$execution.resumeUrl` is automatically generated by n8n
- This URL is unique per execution
- The approval system will POST back to this URL with:
  ```json
  {
    "approved": true/false,
    "timestamp": "2025-01-19T...",
    "approvedBy": "Manual Approval System",
    "executionId": "...",
    "workflowName": "...",
    "originalData": {...}
  }
  ```

## Troubleshooting:

**If workflow doesn't resume:**
- Check that ngrok is running: `ngrok http 3000 --domain=carter.ngrok.app`
- Verify server is running: `npm start`
- Check n8n execution logs for the resumeUrl

**If approval doesn't appear:**
- Ensure HTTP Request node runs BEFORE Wait node
- Check that `$execution.resumeUrl` is being sent
- Look at server logs for errors

## Import Ready Workflow:
Import the `n8n-workflow-example.json` file directly into n8n for a pre-configured workflow.